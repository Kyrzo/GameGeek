<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Phaser - Making your first game, part 1</title>
    <script src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
		#game {
			/*min-height: 10em;*/
			min-height: 2em;
   			position: relative;
		}
		.wrapper {
			margin: 0;
   			position: absolute;
   			top: 50%;
   			transform: translate(0, -50%);
		}

		canvas {

			/*margin: 0;
   			position: absolute;
   			top: 50%;
   			transform: translate(0, -50%);*/


			margin-left: auto;
    		margin-right: auto;
    		width: 800px;


		}

    </style>
</head>
<body>
<div id="game">
	<div class="wrapper">
<script type="text/javascript">

var game = new Phaser.Game(800,600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

var player;
var background;
var platforms;
var cursors;
var stars;

//Tiro
var bullets;
var bullet;
var bulletTime = 0;

var direccion = 1;

var apuntando = false;
var abajo = false;
var arriba = false;

function preload() {

	//Cargamos los assets
 	game.load.image('fondo', 'assets/sky.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('star', 'assets/star.png');
    game.load.spritesheet('monigote', 'assets/monigoteLados.png', 38, 48);
	game.load.image('bala','assets/bala.png');

}

function create() {
	//Cargamos las fisicas arcade para nuestro videojuego
	game.physics.startSystem(Phaser.Physics.ARCADE);

	//Añadimos el sprite de fondo
	game.add.sprite(0, 0, 'fondo');

	//Creamos el grupo de plataformas
    platforms = game.add.group();

    //Le damos propiedades de cuerpo al grupo plataformas
    platforms.enableBody = true;

    // Creamos la variable ground que contendrá las plataformas.
    var ground = platforms.create(0, game.world.height - 64, 'ground');

    // Escalamos el original
    ground.scale.setTo(2, 2);

    // Hacemos que no se pueda mover para que no caiga y se mantenga fijo
    ground.body.immovable = true;

    //  Creamos dos plataformas
    var ledge = platforms.create(400, 400, 'ground');
    ledge.body.immovable = true;

    var ledge2 = platforms.create(-150, 250, 'ground');
    ledge.body.immovable = true;

    //Creamos al personaje jugador
    player = game.add.sprite(32, game.world.height - 150, 'monigote');

    //Creamos las fisicas del personaje
    game.physics.arcade.enable(player);

    // Caracteristicas fisicas del personaje
    player.body.bounce.y = 0.2;
    player.body.gravity.y = 300;
    player.body.collideWorldBounds = true;

    //  Animaciones.
    player.animations.add('left', [17, 19, 21, 23,25,27], 10, true);
    player.animations.add('right', [16,18,20,22,24,26], 10, true);

    //Controles por teclado
     cursors = game.input.keyboard.createCursorKeys();

	 game.input.keyboard.addKeyCapture([ Phaser.Keyboard.SPACEBAR ]);
	 game.input.keyboard.addKeyCapture([ Phaser.Keyboard.G ]);
	 /* Balas */
	
	bullets = game.add.group();
    bullets.enableBody = true;
    bullets.physicsBodyType = Phaser.Physics.ARCADE;
	bullets.createMultiple(30, 'bala');
}

function update() {

	 //  Colisiones de jugador y plataformas
    game.physics.arcade.collide(player, platforms);
	player.body.checkCollision.up = false;
	
	 game.physics.arcade.collide(bullets, platforms,destroyBullet);
    //  Player en estatico
    player.body.velocity.x = 0;
	
	if (game.input.keyboard.isDown(Phaser.Keyboard.G)) {
		apuntando = true;
	}
	else {
	apuntando = false;
	abajo = false;
	arriba = false;
	}
		
		
	if (cursors.down.isDown && player.body.touching.down) {
		abajo = true;
		arriba = false;
		if (direccion == 1) {
			if(apuntando && cursors.right.isDown && cursors.up.isDown)
				player.frame = 30;
			else if (apuntando && cursors.right.isDown && cursors.down.isDown)
				player.frame = 32;
			else
				player.frame = 28;
		}
			
		else if (direccion == -1)
			if(apuntando && cursors.left.isDown && cursors.up.isDown)
				player.frame = 31;
			else if (apuntando && cursors.left.isDown && cursors.down.isDown)
				player.frame = 33;
			else
				player.frame = 29;
		player.animations.stop();
	}
	else if (!abajo) {
	if (!player.body.touching.down)
    {
		player.animations.stop();
		if (cursors.right.isDown) {
			player.body.velocity.x = 150;
			player.frame = 8;
			direccion = 1;
		}
		else if (cursors.left.isDown) {
			player.body.velocity.x = -150;
			player.frame = 9;
			direccion = -1;
		}
			
    }
    else if (cursors.left.isDown && apuntando == false)
    {
        //  Movemos a la izquierda
        player.body.velocity.x = -150;
		
		//AÑADIR
		direccion = -1;

        player.animations.play('left');
    }
    else if (cursors.right.isDown && apuntando == false)
    {
        //  Movemos a la derecha
        player.body.velocity.x = 150;
		
		//AÑADIR
		direccion = 1;

        player.animations.play('right');
    }
    else
    {
        //  Estatico
        player.animations.stop();
		if (direccion == 1)
			player.frame = 0;
		else if (direccion == -1)
			player.frame = 1;
		else 
			direccion = 0;
    }
	}
	
	
    //  Permitimos el salto
	if (cursors.up.isDown && player.body.touching.down && !apuntando)
    {
        player.body.velocity.y = -350;
	}
	// Disparar
	if (game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR) && direccion != 0)
    {
        fireBullet();
    }
}

	function destroyBullet(bullet,platforms) {
		bullet.kill();
	}

	//metodo de disparo
	function fireBullet () {

    if (game.time.now > bulletTime)
    {
        bullet = bullets.getFirstExists(false);

        if (bullet)
        {
            bullet.reset(player.x + 6, player.y - 8);
			if (direccion == -1)
				bullet.body.velocity.x = -300;
			else if (direccion == 1)
				bullet.body.velocity.x = 300;
            bulletTime = game.time.now + 150;
        }
    }
}

	
	
	//  Called if the bullet goes out of the screen
function resetBullet (bullet) {

    bullet.kill();

}

</script>

</body>
</html>